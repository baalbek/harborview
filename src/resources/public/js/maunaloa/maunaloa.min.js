jQuery(document).ready(function(){var node=document.getElementById("my-app");var app=Elm.Maunaloa.Charts.embed(node,{isWeekly:false});var node2=document.getElementById("my-app2");var app2=Elm.Maunaloa.Charts.embed(node2,{isWeekly:true});var repos1=null;var repos2=null;var drawCanvas1=function(chartInfo){drawCanvas(chartInfo,chartInfo.chart,"canvas1");if(chartInfo.chart2!=null){drawCanvas(chartInfo,chartInfo.chart2,"canvas1b")}if(repos1!=null){repos1.reset()}};var drawCanvas2=function(chartInfo){drawCanvas(chartInfo,chartInfo.chart,"canvas2");if(chartInfo.chart2!=null){drawCanvas(chartInfo,chartInfo.chart2,"canvas2b")}if(repos2!=null){repos2.reset()}};app.ports.drawCanvas.subscribe(drawCanvas1);app2.ports.drawCanvas.subscribe(drawCanvas2);var drawCanvas=function(chartInfo,curChart,canvasId){var offsets=chartInfo.xaxis;var canvas=document.getElementById(canvasId);var ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);var myHruler=MAUNALOA.hruler(1300,chartInfo.startdate,offsets);myHruler.lines(ctx,canvas.height,chartInfo.numIncMonths);var myVruler=MAUNALOA.vruler(canvas.height,curChart.valueRange);myVruler.lines(ctx,canvas.width,curChart.numVlines);var lineChart=MAUNALOA.lineChart(myHruler,myVruler,ctx);var strokes=chartInfo.strokes;for(var i=0;i<curChart.lines.length;++i){var line=curChart.lines[i];var curStroke=strokes[i]===undefined?"#000000":strokes[i];lineChart.drawLine(line,curStroke)}if(curChart.candlesticks!=null){lineChart.drawCandlesticks(curChart.candlesticks)}};var drawRiscLines1=function(riscLinesInfo){drawRiscLines(riscLinesInfo,"canvas1x",1)};var drawRiscLines2=function(riscLinesInfo){drawRiscLines(riscLinesInfo,"canvas2x",2)};var drawRiscLines=function(riscLinesInfo,canvasId,reposId){var canvas=document.getElementById(canvasId);var vruler=MAUNALOA.vruler(canvas.height,riscLinesInfo.valueRange);var repos=reposId===1?repos1:repos2;if(repos===null){repos=MAUNALOA.repos.create(canvasId,vruler);if(reposId===1){repos1=repos}else{repos2=repos}}else{repos.reset();repos.vruler=vruler}var riscLines=riscLinesInfo.riscLines;for(var i=0;i<riscLines.length;++i){var rl=riscLines[i];repos.addRiscLines(rl.ticker,rl.optionPrice,rl.risc,rl.be)}};app.ports.drawRiscLines.subscribe(drawRiscLines1);app2.ports.drawRiscLines.subscribe(drawRiscLines2)});var MAUNALOA=MAUNALOA||{};MAUNALOA.vruler=function(chartHeight,valueRange){var double2decimal=function(x,roundingFactor){var rf=roundingFactor||100;return Math.round(x*rf)/rf};var minVal=valueRange[0];var maxVal=valueRange[1];var ppy=chartHeight/(maxVal-minVal);console.log("ppy: "+ppy);var lines=function(ctx,chartWidth,numVlines){ctx.fillStyle="black";ctx.font="16px Arial";ctx.strokeStyle="#bbb";ctx.lineWidth=.25;var step=chartHeight/(numVlines-1);for(var i=0;i<numVlines;++i){var curStep=step*i;var curVal=double2decimal(maxVal-curStep/ppy);ctx.beginPath();ctx.moveTo(0,curStep);ctx.lineTo(chartWidth,curStep);if(i===0){ctx.fillText(curVal,10,curStep+18)}else{ctx.fillText(curVal,10,curStep-5)}ctx.stroke()}};var pixToValue=function(pix){return double2decimal(maxVal-pix/ppy)};var valueToPix=function(v){return Math.round((maxVal-v)*ppy)};return{valueToPix:valueToPix,pixToValue:pixToValue,lines:lines}};MAUNALOA.hruler=function(width,startDateAsMillis,offsets){var x0=offsets[offsets.length-1];var x1=offsets[0]+5;var diffDays=x1-x0;var ppx=width/diffDays;var startDate=new Date(startDateAsMillis);var date2string=function(d){return d.getMonth()+1+"."+d.getFullYear()};var calcPix=function(x){var curDiffDays=x-x0;return ppx*curDiffDays};var dateToPix=function(d){var curOffset=x0+(d-startDate)/day_millis;return calcPix(curOffset)};var day_millis=864e5;var incMonths=function(origDate,numMonths){return new Date(origDate.getFullYear(),origDate.getMonth()+numMonths,1)};var diffDays=function(d0,d1){return(d1-d0)/day_millis};var offsetsToPix=function(){var result=[];for(var i=0;i<offsets.length;++i){result[i]=calcPix(offsets[i])}return result};var lines=function(ctx,chartHeight,numIncMonths){ctx.fillStyle="black";ctx.font="16px Arial";ctx.strokeStyle="#bbb";ctx.lineWidth=.25;var d0x=incMonths(startDate,numIncMonths);var txtY=chartHeight-5;var curX=0;while(curX<width){curX=dateToPix(d0x);ctx.beginPath();ctx.moveTo(curX,0);ctx.lineTo(curX,chartHeight);ctx.stroke();ctx.fillText(date2string(d0x),curX+5,txtY);d0x=incMonths(d0x,numIncMonths)}};var xaxis=offsetsToPix();return{dateToPix:dateToPix,xaxis:xaxis,startDate:startDate,lines:lines}};var MAUNALOA=MAUNALOA||{};MAUNALOA.lineChart=function(hruler,vruler,ctx){var scaleLine=function(line){var result=[];for(var i=0;i<line.length;++i){result.push(vruler.valueToPix(line[i]))}return result};var drawLine=function(line,strokeStyle,lineWidth){ctx.lineWidth=lineWidth||.5;ctx.strokeStyle=strokeStyle;var ys=scaleLine(line);var xs=hruler.xaxis;ctx.beginPath();ctx.moveTo(xs[0],ys[0]);for(var i=1;i<ys.length;++i){var y=ys[i];var x=xs[i];ctx.lineTo(x,y)}ctx.stroke()};var scaleCandlestick=function(candleStick){var o=vruler.valueToPix(candleStick.o);var h=vruler.valueToPix(candleStick.h);var l=vruler.valueToPix(candleStick.l);var c=vruler.valueToPix(candleStick.c);return{o:o,h:h,l:l,c:c}};var scaleCandlesticks=function(cs){var result=[];for(var i=0;i<cs.length;++i){result.push(scaleCandlestick(cs[i]))}return result};var drawCandlestick=function(x,candleStick){var x0=x-4;ctx.beginPath();if(candleStick.c>candleStick.o){ctx.moveTo(x,candleStick.h);ctx.lineTo(x,candleStick.o);ctx.moveTo(x,candleStick.c);ctx.lineTo(x,candleStick.l);var cndlHeight=candleStick.c-candleStick.o;ctx.rect(x0,candleStick.o,8,cndlHeight);ctx.fillRect(x0,candleStick.o,8,cndlHeight)}else{var cndlHeight=candleStick.o-candleStick.c;if(cndlHeight===0){cndlHeight=1;var x1=x+4;ctx.moveTo(x,candleStick.h);ctx.lineTo(x,candleStick.l);ctx.moveTo(x0,candleStick.c);ctx.lineTo(x1,candleStick.c)}else{ctx.moveTo(x,candleStick.h);ctx.lineTo(x,candleStick.c);ctx.moveTo(x,candleStick.o);ctx.lineTo(x,candleStick.l);ctx.rect(x0,candleStick.c,8,cndlHeight)}}ctx.stroke()};var drawCandlesticks=function(cs){ctx.strokeStyle="#000000";ctx.fillStyle="#ffaa00";ctx.lineWidth=.5;var xs=hruler.xaxis;var scs=scaleCandlesticks(cs);var numCandlesticks=scs.length;for(var i=0;i<numCandlesticks;++i){drawCandlestick(xs[i],scs[i])}};return{drawLine:drawLine,drawCandlesticks:drawCandlesticks}};var MAUNALOA=MAUNALOA||{};MAUNALOA.levelLine={color:"black",lineWidth:1,draggable:true,draw:function(repos){var y=this.y1;var ctx=this.parent.ctx;ctx.lineWidth=this.lineWidth;ctx.beginPath();ctx.moveTo(this.x1,y);ctx.lineTo(this.x2,y);ctx.strokeStyle=this.color;ctx.stroke();ctx.fillText(this.legend(),this.x1,y-10)},move:function(dx,dy){this.x1+=dx;this.x2+=dx;this.y1+=dy;this.y2+=dy;this.levelValue=this.parent.vruler.pixToValue(this.y2)},create:function(parent,levelValue,x1,x2,y,conf){var result=Object.create(MAUNALOA.levelLine);result.parent=parent;result.levelValue=levelValue;result.lineWidth=conf.lineWidth||1;result.color=conf.color||"grey";result.x1=x1;result.x2=x2;result.y1=y;result.y2=y;result.legend=conf.legendFn||function(){return this.levelValue};result.draggable=conf.draggable||true;result.onMouseUp=conf.onMouseUp||null;return result}};MAUNALOA.repos={init:function(canvasId,vruler){this.canvas=document.getElementById(canvasId);this.ctx=this.canvas.getContext("2d");this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.vruler=vruler;this.canvas.addEventListener("mouseup",this.handleMouseUp(this),false);this.canvas.addEventListener("mouseout",this.handleMouseOut(this),false);this.canvas.addEventListener("mousedown",this.handleMouseDown(this),false);this.canvas.addEventListener("mousemove",this.handleMouseMove(this),false)},reset:function(){this.lines=[];this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},handleMouseOut:function(self){return function(e){e.preventDefault();e.stopPropagation()}},handleMouseUp:function(self){return function(e){if(self.nearest===null){return}e.preventDefault();e.stopPropagation();var line=self.nearest.line;if(line.onMouseUp!=null){line.onMouseUp()}self.isDown=false;self.nearest=null;self.draw()}},startX:0,startY:9,isDown:false,nearest:null,handleMouseDown:function(self){return function(e){if(self.lines.length===0){return}e.preventDefault();e.stopPropagation();self.startX=e.offsetX;self.startY=e.offsetY;self.nearest=self.closestLine(e.offsetX,e.offsetY);self.draw();self.isDown=true}},handleMouseMove:function(self){return function(e){if(!self.isDown){return}if(self.nearest===null){return}e.preventDefault();e.stopPropagation();var dx=e.offsetX-self.startX;var dy=e.offsetY-self.startY;self.startX=e.offsetX;self.startY=e.offsetY;var line=self.nearest.line;line.move(dx,dy);self.draw()}},lerp:function(a,b,x){return a+x*(b-a)},closestXY:function(line,mx,my){var x0=line.x1;var y0=line.y1;var x1=line.x2;var y1=line.y2;var dx=x1-x0;var dy=y1-y0;var t=((mx-x0)*dx+(my-y0)*dy)/(dx*dx+dy*dy);t=Math.max(0,Math.min(1,t));var x=this.lerp(x0,x1,t);var y=this.lerp(y0,y1,t);return{x:x,y:y}},closestLine:function(mx,my,lines){var len=this.lines.length;if(len===0){return null}var dist=1e8;var index,pt;for(var i=0;i<len;i++){var curLine=this.lines[i];if(curLine.draggable===false){continue}var xy=this.closestXY(curLine,mx,my);var dx=mx-xy.x;var dy=my-xy.y;var thisDist=dx*dx+dy*dy;if(thisDist<dist){dist=thisDist;pt=xy;index=i}}var line=this.lines[index];return{pt:pt,line:line,originalLine:{x1:line.x1,y1:line.y1,x2:line.x2,y2:line.y2}}},draw:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var len=this.lines.length;for(var i=0;i<len;++i){this.lines[i].draw()}if(this.nearest){this.ctx.beginPath();this.ctx.arc(this.nearest.pt.x,this.nearest.pt.y,5,0,Math.PI*2);this.ctx.strokeStyle="red";this.ctx.stroke()}},create:function(canvasId,vruler){var F=function(){this.lines=[]};F.prototype=MAUNALOA.repos;F.constructor.prototype=F;var result=new F;result.init(canvasId,vruler);return result},addLevelLine:function(lineId,levelValue,doDraw){var myDoDraw=doDraw||true;var result=MAUNALOA.levelLine.create(this,levelValue,20,this.canvas.width,this.vruler.valueToPix(levelValue),{id:lineId});this.lines.push(result);if(myDoDraw){this.draw()}},addRiscLines:function(option,risc,riscLevel,breakEven,doDraw){var myDoDraw=doDraw||true;var riscLine=MAUNALOA.levelLine.create(this,riscLevel,20,this.canvas.width,this.vruler.valueToPix(riscLevel),{draggable:true,color:"red",lineWidth:2,legendFn:function(){var curRisc=this.risc||risc;return"["+option+"] Risc: "+curRisc+" => "+this.levelValue},onMouseUp:function(){this.risc="-";console.log("Level: "+this.levelValue);var self=this;HARBORVIEW.Utils.jsonGET("http://localhost:8082/maunaloa/calcrisc",{ticker:option,stockprice:this.levelValue},function(result){console.log("Risc result: "+result);self.risc=parseFloat(result);self.parent.draw()})}});this.lines.push(riscLine);var breakEvenLine=MAUNALOA.levelLine.create(this,breakEven,20,this.canvas.width,this.vruler.valueToPix(breakEven),{draggable:false,color:"green",lineWidth:2,legendFn:function(){return"["+option+"] Break-even: "+this.levelValue}});this.lines.push(breakEvenLine);if(myDoDraw){this.draw()}}};