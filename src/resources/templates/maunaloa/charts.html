<!DOCTYPE html>
<html lang="en">
<head>
    <!--
    <title>Maunaloa - Charts</title>
    -->
    <title>Visual Studio Web Example</title>
    <meta charset="UTF-8">
    {% include "templates/head.html" %}
    <script src="/js/elm/maunaloa/elm-charts.js"></script>
</head>
<body>
    <div class="logo"></div>
    <ul class="nav nav-tabs">
      <li class="active"><a data-toggle="tab" href="#chart1">Daily</a></li>
      <li><a data-toggle="tab" href="#chart2">Weekly</a></li>
    </ul>

    <div class="container">
      <div class="tab-content">
        <div id="chart1" class="tab-pane active">
          <div class="container">
            <div id="my-app"></div>
          </div>
          <div style="position: absolute; top:300px; left:200px;">
            <canvas id="canvas1" width="1310" height="600"></canvas>
          </div>
          <div style="position: absolute; top:950px; left:200px;">
            <canvas id="canvas1b" width="1310" height="600"></canvas>
          </div>
        </div>
        <div id="chart2" class="tab-pane">
          <div class="container">
            <div id="my-app2"></div>
          </div>
          <div style="position: absolute; top:300px; left:200px;">
            <!--
            <canvas style="border:1px solid #000000;" id="canvas2" width="1310" height="600"></canvas>
          -->
            <canvas id="canvas2" width="1310" height="600"></canvas>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
        /*
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var target = $(e.target).attr("href"); // activated tab
            alert(target);
        });
        */
        var node = document.getElementById('my-app');
        var app = Elm.Maunaloa.Charts.embed(node, {
            isWeekly : false
        });

        var node2 = document.getElementById('my-app2');
        var app2 = Elm.Maunaloa.Charts.embed(node2, {
            isWeekly : true
        });
        var drawCanvas1 = function (chartInfo) {
            drawCanvas(chartInfo,'canvas1');
        }
        var drawCanvas2 = function (chartInfo) {
            drawCanvas(chartInfo,'canvas2');
        }
        var drawCanvas = function (chartInfo,canvasId) {
          var canvas = document.getElementById(canvasId);
          var ctx = canvas.getContext("2d");
          ctx.clearRect(0,0,canvas.width,canvas.height);
          var curLines = chartInfo.chartLines.lines;
          for (var i = 0; i < curLines.length; ++i) {
              ctx.beginPath();
              var curStroke = chartInfo.strokes[i] === undefined ? "#000000" : chartInfo.strokes[i];
              var ys = curLines[i];
              drawGraph(ctx,chartInfo.xaxis,ys,curStroke);
          }
          if (chartInfo.candlesticks != null) {
              ctx.strokeStyle = "#000000";
              ctx.fillStyle = "#ffaa00";
              ctx.lineWidth = 0.5;
              for (var i = 0; i < chartInfo.candlesticks.length; ++i) {
                drawCandlestick(ctx,chartInfo.xaxis[i],chartInfo.candlesticks[i]);
              }
          }
        }
        app.ports.drawCanvas.subscribe(drawCanvas1);
        app2.ports.drawCanvas.subscribe(drawCanvas2);
        var drawGraph = function (ctx,xs,ys,strokeStyle) {
          /*
          if (xs.length !== ys.length) {
            return;
          }
          */
          ctx.lineWidth = 0.5;
          // ctx.setLineDash([5,10]);
          ctx.strokeStyle = strokeStyle; // "#FF0000";
          ctx.moveTo(xs[0],ys[0]);
          for (var i = 1; i < ys.length; ++i) {
            var y = ys[i];
            var x = xs[i];
            ctx.lineTo(x,y);
          }
          ctx.stroke();
        }
        var drawCandlestick = function(ctx,x,candleStick) {
          var x0 = x - 4;
          var x1 = x + 5;
          ctx.beginPath();
          if (candleStick.c > candleStick.o) {
              // Bearish
              var cndlHeight = candleStick.c - candleStick.o;
              ctx.moveTo(x,candleStick.h);
              ctx.lineTo(x,candleStick.o);
              ctx.moveTo(x,candleStick.c);
              ctx.lineTo(x,candleStick.l);
              ctx.rect(x0,candleStick.o,8,cndlHeight);
              ctx.fillRect(x0,candleStick.o,8,cndlHeight);

          }
          else {
              // Bullish

          }
          ctx.stroke();
        }
    </script>
</body>
</html>
